<div class="{{ !errmsg ? 'hide' : 'msg error' }}">
  <b on:click="set({ errmsg: '' })">x</b>
  <span>{{ errmsg }}</span>
</div>
<textarea ref:comment_content class="{{ !comment_content_err ? '' : 'error' }}"></textarea>
<div class="inline">
  <input ref:comment_name type="text" class="{{ !comment_name_err ? '' : 'error' }}" placeholder="Name" />
  <button type="button" class="primary" on:click="comment$$()" >Post comment</button>
</div>
<div class="{{ !comment_errmsg ? 'hide' : 'msg error' }}">
  <b on:click="set({ comment_errmsg: '' })">x</b>
  <span>{{ comment_errmsg }}</span>
</div>
<div style="display:none">
  <div ref:reply_form class="reply-form">
    <button type="button" on:click="reply$$hide_form()">x</button>
    <textarea ref:reply_content class="{{ !reply_content_err ? '' : 'error' }}"></textarea>
    <div class="{{ !reply_errmsg ? 'hide' : 'msg error' }}">
      <b on:click="set({ reply_errmsg: '' })">x</b>
      <span>{{ reply_errmsg }}</span>
    </div>
    <div class="inline">
      <input ref:reply_name type="text" class="{{ !reply_name_err ? '' : 'error' }}" placeholder="Name" />
      <button type="button" class="primary" on:click="reply$$()">Post reply</button>
    </div>
  </div>
</div>
<dl class="{{ items.length ? '' : 'hide' }}">
{{#each items as item, i}}
  <Comment item="{{ item }}" />
{{/each}}
</dl>
<script>
import { POST_ID, context, append, extractMsg, toTree, toPayload } from './util'
import * as rpc from './rpc'

import Comment from './Comment.html'

function disable(val, comment_content, comment_name) {
    comment_content.disabled = val
    comment_name.disabled = val
    // button
    comment_name.nextElementSibling.disabled = val
}

function keyupReplyContent(e) {
    // escape key
    e.which === 27 && this.reply$$hide_form()
}

function keyupReplyName(e) {
    // enter key
    e.which === 13 && this.reply$$()
}

function keyupCommentName(e) {
    // enter key
    e.which === 13 && this.comment$$()
}

export default {
    data: () => ({
        loading: true, // fetch after this component is created
        errmg: '',
        items: context.items,

        comment_content_err: false,
        comment_name_err: false,
        comment_errmsg: '',

        reply_content_err: false,
        reply_name_err: false,
        reply_errmsg: ''
    }),
    components: {
        Comment
    },
    helpers: {
        append
    },
    oncreate () {
        context.root$ = this

        let refs = this.refs

        Object.defineProperty(this, 'm', {
            enumerable: false,
            value: {
                fetch$$S: this.fetch$$S.bind(this),
                fetch$$F: this.fetch$$F.bind(this),

                comment$$S: this.comment$$S.bind(this),
                comment$$F: this.comment$$F.bind(this),

                reply$$S: this.reply$$S.bind(this),
                reply$$F: this.reply$$F.bind(this),

                reply_form_parent: refs.reply_form.parentNode
            }
        })

        refs.reply_content.addEventListener('keyup', keyupReplyContent.bind(this))
        refs.reply_name.addEventListener('keyup', keyupReplyName.bind(this))
        refs.comment_name.addEventListener('keyup', keyupCommentName.bind(this))
        
        disable(true, refs.comment_content, refs.comment_name)
        rpc.post('/comments/user/Comment/listAllByPostId', `{"1":${POST_ID}}`)
                .then(this.m.fetch$$S).then(undefined, this.m.fetch$$F)
    },
    methods: {
        fetch$$S(data) {
            let refs = this.refs,
                array = data['1']
            
            disable(false, refs.comment_content, refs.comment_name)

            if (!array || !array.length) {
                this.set({ loading: false })
                return
            }

            //context.raw_items = context.raw_items.concat(array)
            this.set({
                loading: false,
                items: toTree(array, this.get('items'), null)
            })
        },
        fetch$$F(err) {
            let refs = this.refs
            disable(false, refs.comment_content, refs.comment_name)
            this.set({ loading: false, errmsg: extractMsg(err) })
        },
        comment$$S(data) {
            let refs = this.refs,
                comment_content = refs.comment_content,
                comment_name = refs.comment_name,
                array = data['1']
            
            comment_content.value = ''
            comment_name.value = ''

            //context.raw_items = context.raw_items.concat(array)
            disable(false, comment_content, comment_name)
            this.set({
                loading: false, 
                items: toTree(array, this.get('items'))
            })
        },
        comment$$F(err) {
            this.set({ loading: false, comment_errmsg: extractMsg(err) })
        },
        comment$$() {
            let refs = this.refs,
                comment_content = refs.comment_content,
                comment_name = refs.comment_name,
                content = comment_content.value.trim(),
                name = comment_name.value.trim(),
                m = this.m
            
            if (!content) {
                this.set({ comment_content_err: true, comment_name_err: false })
                return
            }
            if (!name) {
                this.set({ comment_content_err: false, comment_name_err: true })
                return
            }

            disable(true, comment_content, comment_name)
            this.set({
                loading: true, errmsg: '',
                comment_content_err: false, comment_name_err: false
            })

            rpc.post('/comments/user/Comment/create', toPayload(name, content))
                    .then(m.comment$$S).then(undefined, m.comment$$F)
        },
        reply$$hide_form() {
            this.m.reply_form_parent.appendChild(this.refs.reply_form)
        },
        reply$$show_form(reply$, pop_target) {
            let refs = this.refs,
                reply_form = refs.reply_form

            context.reply$ = reply$

            pop_target.parentNode.insertBefore(reply_form, pop_target)
            
            refs.reply_content.focus()
        },
        reply$$S(data) {
            let refs = this.refs,
                reply_content = refs.reply_content,
                reply_name = refs.reply_name,
                array = data['1'],
                reply$ = context.reply$,
                item = reply$.get('item')
            
            reply_content.value = ''
            reply_name.value = ''

            toTree(array, item.children, item)

            this.m.reply_form_parent.appendChild(refs.reply_form)
            disable(false, reply_content, reply_name)
            this.set({ loading: false })
            reply$.set({ item: item })
        },
        reply$$F(err) {
            let refs = this.refs
            disable(false, refs.reply_content, refs.reply_name)
            this.set({ loading: false, reply_errmsg: extractMsg(err) })
        },
        reply$$() {
            let refs = this.refs,
                reply_content = refs.reply_content,
                reply_name = refs.reply_name,
                content = reply_content.value.trim(),
                name = reply_name.value.trim(),
                m = this.m
            
            if (!content) {
                this.set({ reply_content_err: true, reply_name_err: false })
                return
            }
            if (!name) {
                this.set({ reply_content_err: false, reply_name_err: true })
                return
            }

            disable(true, reply_content, reply_name)
            this.set({
                loading: true, errmsg: '',
                reply_content_err: false, reply_name_err: false
            })

            rpc.post('/comments/user/Comment/create', toPayload(name, content, context.reply$.get('item')))
                    .then(m.reply$$S).then(undefined, m.reply$$F)
        }
    }
}
</script>
