<div class="comment">
  <span class="name">{{ item['4'] }}</span><span class="timeago">{{ timeago(item['2']) }}</span>
  <div class="content" ref:content></div>
  <button class="{{ append('outlined', !reply_active ? '' : 'hide') }}" on:click="reply$$show_form()">Reply</button>
  <div class="{{ !reply_errmsg ? 'msg hide' : 'msg error' }}">
    <b on:click="set({ reply_errmsg: '' })">x</b>
    <span>{{ reply_errmsg }}</span>
  </div>
  <div class="{{ append('reply', reply_active ? '' : 'hide') }} ">
    <button type="button" on:click="set({ reply_active: false })">x</button>
    <textarea ref:reply_content class="{{ !reply_content_err ? '' : 'error' }}"></textarea>
    <div class="inline">
      <input ref:reply_name type="text" class="{{ !reply_name_err ? '' : 'error' }}" placeholder="Name" />
      <button type="button" class="primary" on:click="reply$$(item)" >Post reply</button>
    </div>
  </div>
  {{#if item.children.length}}
  <dd>
    {{#each item.children as child, i}}
    <:Self item='{{ child }}' index="{{ i }}" />
    {{/each}}
  </dd>
  {{/if}}
</div>
<script>
import { POST_ID, context, timeago, append, extractMsg, toHTML, toPayload, toTree } from './util'
import * as rpc from './rpc'

export default {
    data: () => ({
        reply_active: false,
        reply_content_err: false,
        reply_name_err: false,
        reply_errmsg: '',
        loading: false
    }),
    helpers: {
        timeago,
        append
    },
    oncreate() {
        Object.defineProperty(this, 'm', {
            enumerable: false,
            value: {
                reply$$S: this.reply$$S.bind(this),
                reply$$F: this.reply$$F.bind(this)
            }
        })

        this.refs.content.innerHTML = toHTML(this.get('item')['5'])
    },
    methods: {
        reply$$show_form() {
            this.set({ reply_active: true })
            this.refs.reply_content.focus()
        },
        reply$$S(data) {
            let item = this.get('item'),
                array = data['1'],
                refs = this.refs/*,
                name = refs.reply_name.value*/
            
            refs.reply_content.value = ''
            refs.reply_name.value = ''

            toTree(array, item.children, item)
            this.set({
                loading: false,
                reply_active: false,
                item: item
            })
        },
        reply$$F(err) {
            this.set({ loading: false, reply_errmsg: extractMsg(err) })
        },
        reply$$(item) {
            let content = this.refs.reply_content.value.trim(),
                name = this.refs.reply_name.value.trim(),
                m = this.m
            
            if (!content) {
                this.set({ reply_content_err: true, reply_name_err: false })
                return
            }
            if (!name) {
                this.set({ reply_content_err: false, reply_name_err: true })
                return
            }

            this.set({
                loading: true, errmsg: '',
                top_content_err: false, top_name_err: false
            })

            rpc.post('/comments/user/Comment/create', toPayload(name, content, item))
                    .then(m.reply$$S).then(undefined, m.reply$$F)
        }
    }
}
</script>