<div class="{{ !errmsg ? 'msg' : 'msg error' }}">
  <b>x</b>
  <span>{{ errmsg }}</span>
</div>
<textarea ref:top_content class="{{ !top_content_err ? '' : ' error' }}"></textarea>
<div class="inline">
  <input ref:top_name type="text" class="{{ !top_name_err ? '' : ' error' }}" placeholder="Name" />
  <button class="primary" on:click="top_comment$$()" >Post comment</button>
</div>
<div class="{{ !errmsg ? 'msg' : 'msg is-error' }}">
  <b>x</b>
  <span>{{ top_errmsg }}</span>
</div>
<div>
<dl class="{{ items.length ? '' : 'hide' }}">
{{#each items as item, i}}
  <Comment item='{{ item }}' index='{{ i }}' />
{{/each}}
</dl>
</div>
<script>
import { POST_ID, context, append, extractMsg } from './util'
import * as rpc from './rpc'

import Comment from './Comment.html'

function toPayload(name, content, items) {
    let prefix = !items.length ? '' : `"1":"${items[items.length - 1]['1']}",`
    return `{${prefix}"4":"${name}","5":"${content}","6":${POST_ID}}`
}

function toTree(raw_items, items) {
    let last_item = !items.length ? null : items[items.length - 1],
        last_depth = !last_item ? 0 : last_item.depth,
        item,
        depth
    
    for (var i = 0, len = raw_items.length; i < len; i++) {
        item = raw_items[i]
        item.parent = null
        item.children = []
        if (!(depth = item['7'])) {
            items.push(item)
            last_item = item
            last_depth = depth
            continue
        }
        if (depth === last_depth) {
            (item.parent = last_item.parent).children.push(item)
            last_item = item
            continue
        }
        if (depth > last_depth) {
            (item.parent = last_item).children.push(item)
            last_item = item
            last_depth = depth
            continue
        }

        while (depth !== last_item.parent.depth) {
            last_item = last_item.parent
        }

        (item.parent = last_item.parent).children.push(item)
        last_item = item
        last_depth = depth
    }

    return items
}

export default {
    data: () => ({
        loading: true, // fetch after this component is created
        errmg: '',
        items: [],

        top_content_err: false,
        top_name_err: false,
        top_errmsg: '',

        reply_target: null
    }),
    components: {
        Comment
    },
    helpers: {
        append
    },
    oncreate () {
        Object.defineProperty(this, 'm', {
            enumerable: false,
            value: {
                fetch$$S: this.fetch$$S.bind(this),
                fetch$$F: this.fetch$$F.bind(this),

                top_comment$$S: this.top_comment$$S.bind(this),
                top_comment$$F: this.top_comment$$F.bind(this)
            }
        })
        
        rpc.post('/comments/user/Comment/listAllByPostId', `{"1":${POST_ID}}`)
                .then(this.m.fetch$$S).then(undefined, this.m.fetch$$F)
    },
    methods: {
        fetch$$S(data) {
            let array = data['1']
            
            if (!array || !array.length) {
                this.set({ loading: false })
                return
            }

            context.raw_items = context.raw_items.concat(array)
            this.set({
                loading: false,
                items: toTree(array, this.get('items'))
            })
        },
        fetch$$F(err) {
            this.set({ loading: false, errmsg: extractMsg(err) })
        },
        top_comment$$S(data) {
            let array = data['1'],
                refs = this.refs
            
            refs.top_content.value = ''
            refs.top_name.value = ''

            context.raw_items = context.raw_items.concat(array)
            this.set({
                loading: false,
                items: toTree(array, this.get('items'))
            })
        },
        top_comment$$F(err) {
            this.set({ loading: false, top_errmsg: extractMsg(err) })
        },
        top_comment$$() {
            let content = this.refs.top_content.value.trim(),
                name = this.refs.top_name.value.trim(),
                m = this.m
            
            if (!content) {
                this.set({ top_content_err: true, top_name_err: false })
                return
            }
            if (!name) {
                this.set({ top_content_err: false, top_name_err: true })
                return
            }

            this.set({
                loading: true, errmsg: '',
                top_content_err: false, top_name_err: false
            })

            rpc.post('/comments/user/Comment/create', toPayload(name, content, this.get('items')))
                    .then(m.top_comment$$S).then(undefined, m.top_comment$$F)
        }
    }
}
</script>
