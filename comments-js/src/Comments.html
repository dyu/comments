<div class="{{ !errmsg ? 'msg' : 'msg error' }}">
  <b>x</b>
  <span>{{ errmsg }}</span>
</div>
<textarea ref:comment_content class="{{ !comment_content_err ? '' : 'error' }}"></textarea>
<div class="inline">
  <input ref:comment_name type="text" class="{{ !comment_name_err ? '' : 'error' }}" placeholder="Name" />
  <button type="button" class="primary" on:click="comment$$()" >Post comment</button>
</div>
<div class="{{ !comment_errmsg ? 'msg' : 'msg error' }}">
  <b>x</b>
  <span>{{ comment_errmsg }}</span>
</div>
<div>
<dl class="{{ items.length ? '' : 'hide' }}">
{{#each items as item, i}}
  <Comment item='{{ item }}' index='{{ i }}' />
{{/each}}
</dl>
</div>
<script>
import { POST_ID, context, append, extractMsg, toTree, toPayload } from './util'
import * as rpc from './rpc'

import Comment from './Comment.html'

function disable(val, comment_content, comment_name) {
    comment_content.disabled = val
    comment_name.disabled = val
    // button
    comment_name.nextElementSibling.disabled = val
}

export default {
    data: () => ({
        loading: true, // fetch after this component is created
        errmg: '',
        items: context.items,

        comment_content_err: false,
        comment_name_err: false,
        comment_errmsg: '',

        reply_target: null
    }),
    components: {
        Comment
    },
    helpers: {
        append
    },
    oncreate () {
        Object.defineProperty(this, 'm', {
            enumerable: false,
            value: {
                fetch$$S: this.fetch$$S.bind(this),
                fetch$$F: this.fetch$$F.bind(this),

                comment$$S: this.comment$$S.bind(this),
                comment$$F: this.comment$$F.bind(this)
            }
        })

        let refs = this.refs
        disable(true, refs.comment_content, refs.comment_name)
        rpc.post('/comments/user/Comment/listAllByPostId', `{"1":${POST_ID}}`)
                .then(this.m.fetch$$S).then(undefined, this.m.fetch$$F)
    },
    methods: {
        fetch$$S(data) {
            let refs = this.refs,
                array = data['1']
            
            disable(false, refs.comment_content, refs.comment_name)

            if (!array || !array.length) {
                this.set({ loading: false })
                return
            }

            //context.raw_items = context.raw_items.concat(array)
            this.set({
                loading: false,
                items: toTree(array, this.get('items'), null)
            })
        },
        fetch$$F(err) {
            let refs = this.refs
            disable(false, refs.comment_content, refs.comment_name)
            this.set({ loading: false, errmsg: extractMsg(err) })
        },
        comment$$S(data) {
            let refs = this.refs,
                comment_content = refs.comment_content,
                comment_name = refs.comment_name,
                array = data['1']
            
            comment_content.value = ''
            comment_name.value = ''

            //context.raw_items = context.raw_items.concat(array)
            disable(false, comment_content, comment_name)
            this.set({
                loading: false,
                items: toTree(array, this.get('items'))
            })
        },
        comment$$F(err) {
            this.set({ loading: false, comment_errmsg: extractMsg(err) })
        },
        comment$$() {
            let refs = this.refs,
                comment_content = refs.comment_content,
                comment_name = refs.comment_name,
                content = comment_content.value.trim(),
                name = comment_name.value.trim(),
                m = this.m
            
            if (!content) {
                this.set({ comment_content_err: true, comment_name_err: false })
                return
            }
            if (!name) {
                this.set({ comment_content_err: false, comment_name_err: true })
                return
            }

            disable(true, comment_content, comment_name)
            this.set({
                loading: true, errmsg: '',
                comment_content_err: false, comment_name_err: false
            })

            rpc.post('/comments/user/Comment/create', toPayload(name, content))
                    .then(m.comment$$S).then(undefined, m.comment$$F)
        }
    }
}
</script>
